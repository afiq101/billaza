<!DOCTYPE html>
<html lang="en">
  <%- include('./partials/header.ejs') %>
  <body>
    <center>
      <img class="lg:block h-10 w-auto mt-16" src="../images/logo.png" alt="" />
    </center>
    <div class="max-w-7xl mx-auto px-2 sm:px-6 lg:px-8">
      <div id="app" class="content">
        <h1
          class="text-3xl p-4 font-medium relative top-0 leading-normal text-white container bg-purple-500 rounded-t-xl"
        >
          <i
            onclick="window.location.href = 'http://localhost:3000/list'"
            class="fas fa-arrow-alt-circle-left cursor-pointer pr-4"
          ></i>
          <%- data[0].name %>
        </h1>
        <div class="container mx-auto bg-white p-8 rounded-lg shadow-md">
          <div class="container">
            <div class="grid grid-cols-1">
              <!-- <label for="name" class="font-medium">Bill Name</label>
              <h1 class="text-xl mb-5"><%- data[0].name %></h1> -->
              <label for="name" class="font-bold">Description</label>
              <h1 class="text-xl font-normal mb-5">
                <%- data[0].description %>
              </h1>
              <label for="name" class="font-bold">Amount</label>
              <h1 class="text-xl font-normal mb-5">
                RM<%- data[0].amount.toLocaleString('en-US',
                {maximumFractionDigits:2}) %>
              </h1>

              <label for="name" class="text-xl text-gray-400"
                ><i class="fas fa-paperclip"></i> Attachment</label
              >
              <div class="w-full mb-5">
                <div class="shadow-md">
                  <div class="tab w-full overflow-hidden border-t">
                    <input
                      class="absolute opacity-0"
                      id="tab-single-one"
                      type="radio"
                      name="tabs2"
                    />
                    <label
                      class="block p-5 leading-normal cursor-pointer"
                      for="tab-single-one"
                      >Image</label
                    >
                    <div
                      class="tab-content overflow-hidden border-l-2 bg-gray-100 border-indigo-500 leading-normal"
                    >
                      <div class="grid grid-cols-5 gap-1">
                        <div
                          v-for="datamedia in media"
                          class="mt-3 px-2 relative"
                          v-if="datamedia.type == 'image' && datamedia.buffer == null"
                        >
                          <div class="cover">
                            <img
                              :src="'../' + datamedia.pathurl"
                              class="myImg"
                              width="200"
                              alt=""
                            />
                          </div>
                          <br />
                          <div
                            class="text-gray-400 absolute bottom-0 right-0"
                          ></div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="tab w-full overflow-hidden border-t">
                    <input
                      class="absolute opacity-0"
                      id="tab-single-two"
                      type="radio"
                      name="tabs2"
                    />
                    <label
                      class="block p-5 leading-normal cursor-pointer"
                      for="tab-single-two"
                      >Video</label
                    >
                    <div
                      class="tab-content overflow-hidden border-l-2 bg-gray-100 border-indigo-500 leading-normal"
                    >
                      <div class="grid grid-cols-2 gap-1">
                        <div
                          v-for="datamedia in media"
                          class="mt-3 px-2 relative"
                          v-if="datamedia.type == 'video' && datamedia.buffer == null"
                        >
                          <!-- {{datamedia}} -->
                          <div class="cover">
                            <video controls>
                              <source
                                :src="'../' + datamedia.pathurl"
                                type="video/mp4"
                              />
                            </video>
                          </div>
                          <div
                            class="text-gray-400 absolute bottom-0 right-0"
                          ></div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="tab w-full overflow-hidden border-t">
                    <input
                      class="absolute opacity-0"
                      id="tab-single-three"
                      type="radio"
                      name="tabs2"
                    />
                    <label
                      class="block p-5 leading-normal cursor-pointer"
                      for="tab-single-three"
                      >Audio</label
                    >
                    <div
                      class="tab-content overflow-hidden border-l-2 bg-gray-100 border-indigo-500 leading-normal"
                    >
                      <div class="grid grid-cols-3 gap-1">
                        <div
                          v-for="datamedia in media"
                          class="mt-3 px-2 relative"
                          v-if="datamedia.type == 'audio' && datamedia.buffer == null"
                        >
                          <!-- {{datamedia}} -->
                          <div class="cover">
                            <audio controls>
                              <source
                                :src="'../' + datamedia.pathurl"
                                type="audio/mp3"
                              />
                            </audio>
                          </div>
                          <div
                            class="text-gray-400 absolute bottom-0 right-0"
                          ></div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="tab w-full overflow-hidden border-t">
                    <input
                      class="absolute opacity-0"
                      id="tab-single-four"
                      type="radio"
                      name="tabs2"
                    />
                    <label
                      class="block p-5 leading-normal cursor-pointer"
                      for="tab-single-four"
                      >Document</label
                    >
                    <div
                      class="tab-content overflow-hidden border-l-2 bg-gray-100 border-indigo-500 leading-normal"
                    >
                      <div
                        v-for="datamedia in media"
                        class="mt-3 px-2 relative"
                        v-if="datamedia.type == 'application' && datamedia.buffer == null"
                      >
                        <div class="cover">
                          <!-- {{datamedia}} -->
                          <iframe
                            v-if="datamedia.format == 'pdf'"
                            height="600"
                            width="700"
                            :src="'../'+datamedia.pathurl"
                            allowfullscreen
                            webkitallowfullscreen
                          ></iframe>
                          <iframe
                            v-if="datamedia.format == 'vnd.openxmlformats-officedocument.wordprocessingml.document'"
                            :src="'http://docs.google.com/gview?url=http://localhost:3000/'+datamedia.pathurl+'&embedded=true'"
                            height="600"
                            width="700"
                            frameborder="0"
                            >This is an embedded
                            <a target="_blank" href="http://office.com"
                              >Microsoft Office</a
                            >
                            document, powered by
                            <a target="_blank" href="http://office.com/webapps"
                              >Office Online</a
                            >.</iframe
                          >
                        </div>
                        <div
                          class="text-gray-400 absolute bottom-0 right-0"
                        ></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <button
                class="py-3 px-4 mt-2 float-right font-medium text-lg rounded-lg shadow-md text-white bg-purple-500 hover:bg-purple-700"
                id="checkout-button"
              >
                Pay RM<%- data[0].amount.toLocaleString('en-US',
                {maximumFractionDigits:2}) %>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <%- include('./partials/footer.ejs') %>
    <script>
      var app = new Vue({
        el: "#app",
        data: {
          project_title: "Media Manager",
          media: [],
        },
        mounted() {
          axios
            .get("../api/media/getmed?id=" + "<%= data[0].bill_id  %>")
            .then((res) => {
              // console.log(res.data);
              if (res.data.length != 0) {
                for (let i = 0; i < res.data.length; i++) {
                  this.media.push(res.data[i]);
                }
              }
            });
        },
        computed: {
          filteredImage() {
            return this.media.filter((item) => item.type === "image");
          },
        },
      });

      /* Optional Javascript to close the radio button version by clicking it again */
      var myRadios = document.getElementsByName("tabs2");
      var setCheck;
      var x = 0;
      for (x = 0; x < myRadios.length; x++) {
        myRadios[x].onclick = function () {
          if (setCheck != this) {
            setCheck = this;
          } else {
            this.checked = false;
            setCheck = null;
          }
        };
      }

      var stripe = Stripe(
        "pk_test_51Ig0fgGunXd2RLUSvJligqlE1MBNBsWTeiv8pf4SKzecqiQY9AioW24BHMswsiHzz1xXKe5blum73MlSxvVdVyso00qRtVk8HS"
      );
      var checkoutButton = document.getElementById("checkout-button");
      checkoutButton.addEventListener("click", function () {
        // let formData = new FormData();
        // formData.append("name", "<%= data[0].name %>");
        // formData.append("description", "<%= data[0].description %>");
        // formData.append("totalamount", "<%= data[0].amount * 100 %>");

        fetch("../api/pay/create-checkout-session", {
          method: "POST",
          headers: {
            Accept: "application/json, text/plain, */*",
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            name: "<%= data[0].name %>",
            desc: "<%= data[0].description %>",
            amount: "<%= data[0].amount * 100 %>",
          }),
        })
          .then(function (response) {
            return response.json();
          })
          .then(function (session) {
            return stripe.redirectToCheckout({ sessionId: session.id });
          })
          .then(function (result) {
            // If redirectToCheckout fails due to a browser or network
            // error, you should display the localized error message to your
            // customer using error.message.
            if (result.error) {
              alert(result.error.message);
            }
          })
          .catch(function (error) {
            console.error("Error:", error);
          });
      });
    </script>
  </body>
</html>
